name: Merge PR
on:
  pull_request:
    types:
      - closed
      # - synchronize
    branches:
      - main
concurrency:
  group: merge
  cancel-in-progress: false
jobs:
  build-binaries:
    strategy:
      matrix:
        binary:
          - architecture: x86_64-linux
            runner: ubuntu-22.04
          - architecture: aarch64-linux
            runner: ubuntu-22.04-arm
          - architecture: aarch64-darwin
            runner: macos-15-xlarge # Uses Apple Silicon M2 hardware 5vCPU, 14GB RAM and 14GB SSD. 8-core GPU
          - architecture: x86_64-darwin
            runner: macos-15-intel # Uses Intel hardware 4vCPU, 14GB RAM and 14GB SSD
    name: Binary ${{ matrix.binary.architecture }}
    uses: ./.github/workflows/build-binaries.yaml
    with:
      branch: ${{ github.event.pull_request.base.ref }}
      runner: ${{ matrix.binary.runner }}
      architecture: ${{ matrix.binary.architecture }}
      version_type: "pr"
    secrets: inherit
  comment:
    name: Comment PR
    runs-on: ubuntu-latest # Use default runner for utility jobs
    needs:
      - build-binaries
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Get version
        id: vars
        run: |
          set -x
          pr_version=$(grep -E '^version\s*=' Cargo.toml | awk -F\" '{print $2}')-pr.${{ github.event.pull_request.number }}
          echo "pr_version=$pr_version" >> $GITHUB_OUTPUT
      - name: Create comment
        uses: peter-evans/create-or-update-comment@v5
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            The binaries for this PR can be downloaded via:
            ```
            mkdir ./binaries

            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-worker-x86_64-linux --destination=./binaries --local-filename=gnosis_vpn-worker-x86_64-linux
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-root-x86_64-linux --destination=./binaries --local-filename=gnosis_vpn-root-x86_64-linux
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-ctl-x86_64-linux --destination=./binaries --local-filename=gnosis_vpn-ctl-x86_64-linux

            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-worker-aarch64-linux --destination=./binaries --local-filename=gnosis_vpn-worker-aarch64-linux
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-root-aarch64-linux --destination=./binaries --local-filename=gnosis_vpn-root-aarch64-linux
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-ctl-aarch64-linux --destination=./binaries --local-filename=gnosis_vpn-ctl-aarch64-linux

            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-worker-aarch64-darwin --destination=./binaries --local-filename=gnosis_vpn-worker-aarch64-darwin
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-root-aarch64-darwin --destination=./binaries --local-filename=gnosis_vpn-root-aarch64-darwin
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-ctl-aarch64-darwin --destination=./binaries --local-filename=gnosis_vpn-ctl-aarch64-darwin

            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-worker-x86_64-darwin --destination=./binaries --local-filename=gnosis_vpn-worker-x86_64-darwin
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-root-x86_64-darwin --destination=./binaries --local-filename=gnosis_vpn-root-x86_64-darwin
            gcloud artifacts files download --project=gnosisvpn-production --location=europe-west3 --repository=rust-binaries gnosis_vpn:${{ steps.vars.outputs.pr_version }}:gnosis_vpn-ctl-x86_64-darwin --destination=./binaries --local-filename=gnosis_vpn-ctl-x86_64-darwin
            ```
  cache-deps:
    name: Cache deps
    if: github.event.pull_request.merged == true
    uses: ./.github/workflows/cache-deps.yaml
    with:
      branch: ${{ github.event.pull_request.base.ref }}
    secrets: inherit
