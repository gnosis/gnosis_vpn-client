#!/bin/bash
#
# Gnosis VPN Post-Installation Script
#
# This script runs after the package payload is installed.
# It performs:
# - Configuration file generation (config.toml)
# - Backup of existing configuration (if present)
# - Final permission adjustments
# - Optional convenience symlinks
#
# Arguments:
#   $1: Full path to the installation package
#   $2: Full path to the installation destination (target volume)
#   $3: Mountpoint of the destination volume
#   $4: Root directory "/" for the current system
#
# Environment variables from Distribution.xml choices:
#   INSTALLER_CHOICE_NETWORK: "rotsee" or "dufour"

set -euo pipefail

# Configuration
CONFIG_DIR="${2}/etc/gnosisvpn"
CONFIG_FILE="${CONFIG_DIR}/config.toml"
TEMPLATE_DIR="${CONFIG_DIR}/templates"
BIN_DIR="${2}/usr/local/bin"
NETWORK="${INSTALLER_CHOICE_NETWORK:-rotsee}"

# Validate network selection (whitelist)
if [[ ! "$NETWORK" =~ ^(rotsee|dufour)$ ]]; then
    echo "ERROR: Invalid network selection: $NETWORK"
    echo "Valid options: rotsee, dufour"
    exit 1
fi

# Create log directory if it doesn't exist
LOG_DIR="/Library/Logs/GnosisVPNInstaller"
mkdir -p "$LOG_DIR"
LOG_FILE="${LOG_DIR}/postinstall.log"

# Redirect all output to log file
exec >> "$LOG_FILE" 2>&1

echo "=========================================="
echo "Gnosis VPN Post-Installation Script"
echo "=========================================="
echo "Started at: $(date)"
echo "Install package: $1"
echo "Target volume: $2"
echo "Binary directory: $BIN_DIR"
echo "Configuration directory: $CONFIG_DIR"
echo "Configuration file: $CONFIG_FILE"
echo "Network: $NETWORK"
echo ""

# Backup existing configuration if present
backup_config() {
    # Create config directory if it doesn't exist
    mkdir -p "$CONFIG_DIR"

    if [[ -f "$CONFIG_FILE" ]]; then
        local timestamp
        timestamp=$(date +%Y%m%d-%H%M%S)
        local backup_file="${CONFIG_DIR}/config-${timestamp}.toml.backup"

        echo "Existing configuration found. Creating backup..."
        if cp "$CONFIG_FILE" "$backup_file"; then
            echo "✓ Backup created: $backup_file"
        else
            echo "WARNING: Failed to create backup of existing config"
        fi
        echo ""
    fi
}

# Generate destinations configuration based on network selection
generate_destinations() {
    local template_file="${TEMPLATE_DIR}/${NETWORK}.toml.template"

    # Check if template file exists
    if [[ ! -f "$template_file" ]]; then
        echo "ERROR: Template file not found: $template_file"
        echo "Falling back to default configuration"
        # Fallback to rotsee template
        template_file="${TEMPLATE_DIR}/rotsee.toml.template"
        if [[ ! -f "$template_file" ]]; then
            echo "ERROR: Default template file not found: $template_file"
            exit 1
        fi
    fi

    # Read and output template content
    cat "$template_file"
}


# Generate the configuration file
generate_config() {
    echo "Generating configuration file..."

    local destinations
    destinations=$(generate_destinations)

    # Write configuration file
    cat > "$CONFIG_FILE" <<EOF
###
# Gnosis VPN service configuration file
#
# On unix the default config path is \`/etc/gnosisvpn/config.toml\`
# However you can override this by using \`GNOSISVPN_CONFIG_PATH\` env var
#
# Generated by installer on $(date)
# Network: $NETWORK
###

version = 4

${destinations}
EOF

    if [[ -f "$CONFIG_FILE" ]]; then
        echo "✓ Configuration file created: $CONFIG_FILE"
    else
        echo "ERROR: Failed to create configuration file"
        exit 1
    fi
    echo ""
}

# Set proper file permissions
set_permissions() {
    echo "Setting file permissions..."

    chmod 755 "$BIN_DIR/gnosis_vpn" 2>/dev/null || true
    chmod 755 "$BIN_DIR/gnosis_vpn-ctl" 2>/dev/null || true
    chmod 644 "$CONFIG_FILE" 2>/dev/null || true

    # Make the config directory readable by all users
    chmod 755 "$CONFIG_DIR" 2>/dev/null || true

    echo "✓ Permissions set"
    echo ""
}

# Verify binaries are in PATH
verify_path() {
    echo "Verifying binaries are in PATH..."

    # Binaries are already in /usr/local/bin which is typically in PATH
    echo "✓ Binaries installed to $BIN_DIR (typically in PATH)"
    echo "  You should be able to run 'gnosis_vpn' and 'gnosis_vpn-ctl' from anywhere"
    echo ""
}

# Verify installation
verify_installation() {
    echo "Verifying installation..."

    local errors=0

    if [[ ! -x "$BIN_DIR/gnosis_vpn" ]]; then
        echo "ERROR: gnosis_vpn binary not found or not executable"
        errors=$((errors + 1))
    fi

    if [[ ! -x "$BIN_DIR/gnosis_vpn-ctl" ]]; then
        echo "ERROR: gnosis_vpn-ctl binary not found or not executable"
        errors=$((errors + 1))
    fi

    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "ERROR: Configuration file not found"
        errors=$((errors + 1))
    fi

    if [[ $errors -gt 0 ]]; then
        echo ""
        echo "Installation verification failed with $errors error(s)"
        exit 1
    fi

    echo "✓ Installation verified successfully"
    echo ""
}

# Print installation summary
print_summary() {
    echo "=========================================="
    echo "Installation Summary"
    echo "=========================================="
    echo "Binary directory: $BIN_DIR"
    echo "Configuration file: $CONFIG_FILE"
    echo "Network: $NETWORK"
    echo ""
    echo "Installed binaries:"
    ls -lh "$BIN_DIR"/gnosis_vpn* 2>/dev/null || true
    echo ""
    echo "To get started:"
    echo "  1. sudo gnosis_vpn -c $CONFIG_FILE"
    echo "  2. gnosis_vpn-ctl status"
    echo ""
    echo "Log file: $LOG_FILE"
    echo "=========================================="
    echo "Post-installation completed successfully!"
    echo "=========================================="
    echo ""
}

# Main execution
main() {
    backup_config
    generate_config
    set_permissions
    verify_path
    verify_installation
    print_summary
}

# Execute main function
main

exit 0
